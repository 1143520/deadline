<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>提醒事项管理</title>
    <link rel="icon" href="logo.png" type="image/png">
    <link rel="shortcut icon" href="logo.png" type="image/png">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>提醒事项管理</h1>
            <button id="openAddForm" class="add-button">添加新提醒</button>
        </div>
        
        <!-- 弹出式添加提醒表单 -->
        <div id="addFormModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>添加新提醒</h2>
                    <span class="close">&times;</span>
                </div>
                <form id="reminderForm">
                    <div class="form-group">
                        <label for="title">项目名称:</label>
                        <input type="text" id="title" required>
                    </div>
                    <div class="form-group">
                        <label for="content">项目内容:</label>
                        <textarea id="content" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="remindTime">提醒时间:</label>
                        <input type="datetime-local" id="remindTime" required>
                    </div>
                    <div class="form-group">
                        <label for="cycleType">循环类型:</label>
                        <select id="cycleType" required>
                            <option value="once">单次提醒</option>
                            <option value="weekly">每周循环</option>
                            <option value="monthly">每月循环</option>
                            <option value="yearly">每年循环</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">添加提醒</button>
                        <button type="button" class="cancel-btn" onclick="closeModal()">取消</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- 提醒列表 -->
        <div class="reminders-grid" id="remindersList"></div>
    </div>

    <script>
        // 使用相对路径，自动适应当前域名
        const API_BASE = '/api/reminders';
        
        // 格式化时间
        function formatDateTime(date) {
            const d = new Date(date);
            // 使用时间戳减去8小时（8 * 60 * 60 * 1000 毫秒）
            const adjustedDate = new Date(d.getTime() - 8 * 60 * 60 * 1000);
            return adjustedDate.toLocaleString('zh-CN');
        }

        // 转换本地时间为UTC时间
        function localToUTC(dateString) {
            const date = new Date(dateString);
            return new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString();
        }

        // 删除提醒
        async function deleteReminder(id, cronJobId) {
            if (!confirm('确定要删除这个提醒吗？')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ cronJobId })
                });

                if (response.ok) {
                    alert('提醒删除成功！');
                    loadReminders();
                } else {
                    const error = await response.text();
                    throw new Error(error || '删除失败');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('删除提醒失败：' + error.message);
            }
        }

        // 添加提醒
        async function addReminder(event) {
            event.preventDefault();
            
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            const remindTime = document.getElementById('remindTime').value;
            const cycleType = document.getElementById('cycleType').value;

            const reminder = {
                id: Date.now().toString(),
                title,
                content,
                remind_time: localToUTC(remindTime),
                cycle_type: cycleType,
                status: 0
            };

            try {
                const response = await fetch(API_BASE, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(reminder)
                });

                const responseText = await response.text();
                console.log('Response:', responseText);

                if (response.ok) {
                    alert('提醒添加成功！');
                    closeModal();
                    loadReminders();
                } else {
                    throw new Error(responseText || '添加失败');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('添加提醒失败：' + error.message);
            }
        }

        // 计算下一次提醒时间
        function calculateNextRemindTime(currentTime, cycleType) {
            const date = new Date(currentTime);
            const timestamp = date.getTime();
            
            // 计算各个周期的毫秒数
            const DAY_MS = 24 * 60 * 60 * 1000;
            const WEEK_MS = 7 * DAY_MS;
            
            switch(cycleType) {
                case 'weekly':
                    return new Date(timestamp + WEEK_MS);
                case 'monthly': {
                    // 获取当前月份的天数
                    const year = date.getFullYear();
                    const month = date.getMonth();
                    const day = date.getDate();
                    const hour = date.getHours();
                    const minute = date.getMinutes();
                    const second = date.getSeconds();
                    
                    // 创建下个月的同一天
                    let nextDate = new Date(year, month + 1, day, hour, minute, second);
                    
                    // 如果结果是无效日期（比如 1月31日 -> 2月31日），回退到月底
                    if (nextDate.getMonth() !== (month + 1) % 12) {
                        nextDate = new Date(year, month + 2, 0, hour, minute, second); // 设置为下个月的最后一天
                    }
                    
                    return nextDate;
                }
                case 'yearly': {
                    const year = date.getFullYear();
                    const month = date.getMonth();
                    const day = date.getDate();
                    const hour = date.getHours();
                    const minute = date.getMinutes();
                    const second = date.getSeconds();
                    
                    // 创建明年的同一天
                    let nextDate = new Date(year + 1, month, day, hour, minute, second);
                    
                    // 处理2月29日的特殊情况
                    if (month === 1 && day === 29 && !isLeapYear(year + 1)) {
                        nextDate = new Date(year + 1, 1, 28, hour, minute, second);
                    }
                    
                    return nextDate;
                }
                default:
                    return null;
            }
        }

        // 判断是否闰年
        function isLeapYear(year) {
            return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
        }

        // 加载提醒列表
        async function loadReminders() {
            try {
                const response = await fetch(API_BASE);
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || '加载失败');
                }
                const reminders = await response.json();
                
                const listElement = document.getElementById('remindersList');
                listElement.innerHTML = '';

                reminders.sort((a, b) => new Date(a.remind_time) - new Date(b.remind_time));

                reminders.forEach(reminder => {
                    const cycleText = {
                        'once': '单次提醒',
                        'weekly': '每周循环',
                        'monthly': '每月循环',
                        'yearly': '每年循环'
                    }[reminder.cycle_type] || '单次提醒';

                    // 计算下一次提醒时间
                    let nextRemindTime = null;
                    const currentTime = new Date(reminder.remind_time);
                    const now = new Date();

                    if (reminder.status === 1 && reminder.cycle_type !== 'once') {
                        nextRemindTime = calculateNextRemindTime(reminder.remind_time, reminder.cycle_type);
                    }

                    const reminderElement = document.createElement('div');
                    reminderElement.className = 'reminder-card';
                    reminderElement.innerHTML = `
                        <div class="card-header">
                            <h3>${reminder.title}</h3>
                            <span class="status ${reminder.status === 0 ? 'pending' : 'completed'}">
                                ${reminder.status === 0 ? '待提醒' : '已提醒'}
                            </span>
                        </div>
                        <div class="card-content">
                            <p class="content-text">${reminder.content}</p>
                            <p class="time-text">
                                <svg class="icon" viewBox="0 0 1024 1024" width="16" height="16">
                                    <path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"/>
                                    <path d="M686.7 638.6L544.1 535.5V288c0-4.4-3.6-8-8-8H488c-4.4 0-8 3.6-8 8v275.4c0 2.6 1.2 5 3.3 6.5l165.4 120.6c3.6 2.6 8.6 1.8 11.2-1.7l28.6-39c2.6-3.7 1.8-8.7-1.8-11.2z"/>
                                </svg>
                                ${formatDateTime(reminder.remind_time)}
                            </p>
                            ${nextRemindTime ? `
                            <p class="time-text next-remind">
                                <svg class="icon" viewBox="0 0 1024 1024" width="16" height="16">
                                    <path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"/>
                                    <path d="M686.7 638.6L544.1 535.5V288c0-4.4-3.6-8-8-8H488c-4.4 0-8 3.6-8 8v275.4c0 2.6 1.2 5 3.3 6.5l165.4 120.6c3.6 2.6 8.6 1.8 11.2-1.7l28.6-39c2.6-3.7 1.8-8.7-1.8-11.2z"/>
                                </svg>
                                下次提醒: ${formatDateTime(nextRemindTime)}
                            </p>
                            ` : ''}
                            <p class="cycle-text">
                                <svg class="icon" viewBox="0 0 1024 1024" width="16" height="16">
                                    <path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z"/>
                                    <path d="M686.7 638.6L544.1 535.5V288c0-4.4-3.6-8-8-8H488c-4.4 0-8 3.6-8 8v275.4c0 2.6 1.2 5 3.3 6.5l165.4 120.6c3.6 2.6 8.6 1.8 11.2-1.7l28.6-39c2.6-3.7 1.8-8.7-1.8-11.2z"/>
                                </svg>
                                ${cycleText}
                            </p>
                        </div>
                        <div class="card-actions">
                            <button class="delete-btn" onclick="deleteReminder('${reminder.id}', '${reminder.cron_job_id}')">
                                <svg class="icon" viewBox="0 0 1024 1024" width="16" height="16">
                                    <path d="M360 184h-8c4.4 0 8-3.6 8-8v8h304v-8c0 4.4 3.6 8 8 8h-8v72h72v-80c0-35.3-28.7-64-64-64H352c-35.3 0-64 28.7-64 64v80h72v-72z"/>
                                    <path d="M864 256H160c-17.7 0-32 14.3-32 32v32c0 4.4 3.6 8 8 8h60.4l24.7 523c1.6 34.1 29.8 61 63.9 61h454c34.2 0 62.3-26.8 63.9-61l24.7-523H888c4.4 0 8-3.6 8-8v-32c0-17.7-14.3-32-32-32zM731.3 840H292.7l-24.2-512h487l-24.2 512z"/>
                                </svg>
                                删除
                            </button>
                        </div>
                    `;
                    listElement.appendChild(reminderElement);
                });
            } catch (error) {
                console.error('Error:', error);
                alert('加载提醒列表失败：' + error.message);
            }
        }

        // 添加模态窗口相关的代码
        const modal = document.getElementById('addFormModal');
        const openBtn = document.getElementById('openAddForm');
        const closeBtn = document.getElementsByClassName('close')[0];

        openBtn.onclick = function() {
            modal.style.display = "block";
        }

        closeBtn.onclick = function() {
            closeModal();
        }

        function closeModal() {
            modal.style.display = "none";
            document.getElementById('reminderForm').reset();
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }

        // 事件监听
        document.getElementById('reminderForm').addEventListener('submit', addReminder);
        
        // 初始加载
        loadReminders();

        // 设置datetime-local的最小值为当前时间
        const remindTimeInput = document.getElementById('remindTime');
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        remindTimeInput.min = now.toISOString().slice(0, 16);
    </script>
</body>
</html> 